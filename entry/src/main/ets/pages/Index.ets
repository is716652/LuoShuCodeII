/**
 * æ²³æ´›çœŸæ•° - ä¸»é¡µé¢
 * å…¨æ–°UIè®¾è®¡
 */
import { HeluoService } from '../service/HeluoService';
import {
  CalendarData,
  BenMingInfo,
  FanjuAnalysis,
  HuagongAnalysis,
  HeluoAnalysis,
  YouNianAnalysis,
  YouNianRelation,
  QiuShuAnalysis,
  ZhengTongGuaResult,
  NianGanGuaResult,
  TiYongAnalysisResult,
  XiangDangResult,
  YuanTangInfo,
  LiuYueGuaInfo,
  LiuRiGuaInfo,
  XiaoXiangResult,
  NaJiaPanResult,
  YaoWithNaJia,
  PaipanRecord,
  TermExplanation
} from '../model/HeluoModels';
import { BaguaChart, GuaDetailDialog, GuaInfo, BAGUA_DATA } from '../components/BaguaChart';
import { YouNianChart } from '../components/YouNianChart';
import { QiuShuChart } from '../components/QiuShuChart';
import { ZhengTongGuaChart } from '../components/ZhengTongGuaChart';
import { NianGanGuaChart } from '../components/NianGanGuaChart';
import { TiYongAnalysis } from '../components/TiYongAnalysis';
import { XiangDangChart } from '../components/XiangDangChart';
import { StorageUtil } from '../utils/StorageUtil';

// å†œå†æœˆä»½åç§°
const LUNAR_MONTHS: string[] = ['æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'å†¬', 'è…Š'];

// å†œå†æ—¥æœŸåç§°
const LUNAR_DAYS: string[] = [
  'åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
  'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
  'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'
];

// æ—¶è¾°æ•°æ®
const SHICHEN_LIST: string[] = [
  'å­æ—¶ (23:00-01:00)', 'ä¸‘æ—¶ (01:00-03:00)', 'å¯…æ—¶ (03:00-05:00)', 'å¯æ—¶ (05:00-07:00)',
  'è¾°æ—¶ (07:00-09:00)', 'å·³æ—¶ (09:00-11:00)', 'åˆæ—¶ (11:00-13:00)', 'æœªæ—¶ (13:00-15:00)',
  'ç”³æ—¶ (15:00-17:00)', 'é…‰æ—¶ (17:00-19:00)', 'æˆŒæ—¶ (19:00-21:00)', 'äº¥æ—¶ (21:00-23:00)'
];

const SHICHEN_NAMES: string[] = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];

// é¢„å®šä¹‰ Select é€‰é¡¹
class SelectOptionItem {
  value: string = '';
  constructor(val: string) {
    this.value = val;
  }
}

function getShichenOptions(): SelectOptionItem[] {
  const options: SelectOptionItem[] = [];
  for (const item of SHICHEN_LIST) {
    const opt = new SelectOptionItem(item);
    options.push(opt);
  }
  return options;
}

@Entry
@Component
struct Index {
  @State selectedYear: number = 1990;
  @State selectedMonth: number = 1;
  @State selectedDay: number = 1;
  @State selectedShichen: number = 6;
  @State selectedGender: number = 0; // 0=ç”·, 1=å¥³
  @State isLoading: boolean = false;
  @State hasResult: boolean = false;
  @State analysis: HeluoAnalysis | null = null;
  @State errorMsg: string = '';

  // Tabåˆ†é¡µç´¢å¼•
  @State currentTabIndex: number = 0;

  // å…«å¦å¼¹çª—ç›¸å…³
  @State showGuaDetail: boolean = false;
  @State selectedGua: GuaInfo = new GuaInfo();
  @State isYuanqiGua: boolean = false;

  // æ¸¸å¹´å›¾ç›¸å…³
  @State younianAnalysis: YouNianAnalysis = new YouNianAnalysis();
  @State showYounianDetail: boolean = false;
  @State selectedYounianRel: YouNianRelation = new YouNianRelation();

  // æ±‚æ•°æ³•ç›¸å…³
  @State qiushuAnalysis: QiuShuAnalysis = new QiuShuAnalysis();

  // æˆå¦æ³•ç›¸å…³
  @State zhengTongGua: ZhengTongGuaResult = new ZhengTongGuaResult();
  @State nianGanGua: NianGanGuaResult = new NianGanGuaResult();
  @State tiYongResult: TiYongAnalysisResult = new TiYongAnalysisResult();

  // å…«å¦ç›¸è¡æ³•ç›¸å…³
  @State xiangDangResult: XiangDangResult = new XiangDangResult();

  // å®šå…ƒå ‚å¼ã€èµ·æœˆå¦ã€èµ·æ—¥å¦ã€å…­äº²çº³ç”²ç›¸å…³
  @State yuanTangInfo: YuanTangInfo = new YuanTangInfo();
  @State liuYueGuaList: LiuYueGuaInfo[] = [];
  @State liuRiGua: LiuRiGuaInfo = new LiuRiGuaInfo();
  @State xiaoXiangResult: XiaoXiangResult = new XiaoXiangResult();
  @State naJiaPan: NaJiaPanResult = new NaJiaPanResult();

  // å†å²è®°å½•ç›¸å…³
  @State historyList: PaipanRecord[] = [];
  @State showHistoryDialog: boolean = false;

  // æœ¯è¯­è§£é‡Šç›¸å…³
  @State showTermDialog: boolean = false;
  @State selectedTerm: TermExplanation | null = null;

  private heluoService: HeluoService | null = null;
  private guaDialogController: CustomDialogController | null = null;

  aboutToAppear(): void {
    this.heluoService = new HeluoService(getContext(this));
    this.heluoService.initialize();
    // åˆå§‹åŒ–å­˜å‚¨å·¥å…·
    StorageUtil.init(getContext(this));
    // åŠ è½½å†å²è®°å½•
    this.loadHistory();
  }

  async doAnalyze(): Promise<void> {
    if (!this.heluoService) return;
    this.isLoading = true;
    this.errorMsg = '';
    try {
      this.analysis = await this.heluoService.analyze(
        this.selectedYear,
        this.selectedMonth,
        this.selectedDay,
        this.selectedShichen
      );
      // æ¸¸å¹´åˆ†æ
      if (this.analysis.benMing) {
        this.younianAnalysis = this.heluoService.analyzeYounian(this.analysis.benMing.gua);
      }
      // æ±‚æ•°æ³•åˆ†æ
      if (this.analysis.calendar) {
        this.qiushuAnalysis = this.heluoService.analyzeQiuShu(this.analysis.calendar);

        // æˆå¦æ³•åˆ†æ
        const gender = this.selectedGender === 0 ? 'ç”·' : 'å¥³';
        this.zhengTongGua = await this.heluoService.analyzeZhengTongGua(
          this.qiushuAnalysis,
          gender,
          this.analysis.calendar.year_gan
        );
        this.nianGanGua = await this.heluoService.analyzeNianGanGua(
          this.qiushuAnalysis,
          this.analysis.calendar.year_gan,
          gender,
          this.analysis.calendar.day_zhi
        );
        this.tiYongResult = this.heluoService.analyzeTiYong(this.zhengTongGua, this.nianGanGua);

        // å…«å¦ç›¸è¡æ³•åˆ†æï¼ˆæ¨æ¼”æœªæ¥10å¹´æµå¹´ï¼‰
        const currentYear = new Date().getFullYear();
        this.xiangDangResult = await this.heluoService.analyzeXiangDang(
          this.zhengTongGua,
          gender,
          this.analysis.calendar.year_gan,
          currentYear,
          10
        );

        // å…­äº²çº³ç”²ï¼šå¯¹å½“å‰æµå¹´å¦è£…å…­äº²ã€å®šä¸–åº”ã€æŸ¥æ—ºè¡°
        this.naJiaPan = new NaJiaPanResult();
        if (this.xiangDangResult.currentLiuNian && this.xiangDangResult.currentLiuNian.liuNianGua &&
          this.xiangDangResult.currentLiuNian.liuNianGua.name !== '') {
          this.naJiaPan = await this.heluoService.analyzeNaJiaForGua(
            this.xiangDangResult.currentLiuNian.liuNianGua.name,
            this.analysis.calendar.day_gan,
            this.analysis.calendar.month_zhi,
            this.analysis.calendar.solar_term || ''
          );
        }

        // å®šå…ƒå ‚å¼ï¼šæ ¹æ®æœ¬å‘½å¦å’Œæ—¶è¾°å®šå…ƒå ‚
        if (this.zhengTongGua.mingGua.name !== '') {
          this.yuanTangInfo = this.heluoService.defineYuanTang(
            this.zhengTongGua.mingGua,
            this.selectedShichen,
            gender,
            this.analysis.calendar.year_gan,
            this.analysis.calendar.solar_term || ''
          );

          // èµ·æœˆå¦ï¼š12ä¸ªæœˆçš„æµæœˆè¿åŠ¿
          this.liuYueGuaList = [];
          for (let m = 1; m <= 12; m++) {
            const liuYueGua = this.heluoService.calculateLiuYueGua(
              this.yuanTangInfo.yaoPosition,
              this.analysis.calendar.day_gan,
              m
            );
            this.liuYueGuaList.push(liuYueGua);
          }
        }

        // èµ·æ—¥å¦ï¼šä»Šæ—¥è¿åŠ¿
        this.liuRiGua = this.heluoService.calculateLiuRiGua(
          this.analysis.calendar.day_zhi,
          this.analysis.calendar.day_gan
        );

        // å°è±¡è¡Œå¹´ï¼šè®¡ç®—å½“å‰è™šå²å¹´é¾„çš„è¿åŠ¿
        if (this.yuanTangInfo.yaoPosition > 0) {
          const birthYear = this.selectedYear;
          const currentYear = new Date().getFullYear();
          const age = currentYear - birthYear + 1; // è™šå²
          this.xiaoXiangResult = this.heluoService.calculateXiaoXiang(
            this.yuanTangInfo.yaoPosition,
            age,
            gender,
            this.analysis.calendar.year_gan
          );
        }
      }
      this.hasResult = true;

      // ä¿å­˜åˆ°å†å²è®°å½•
      await this.saveToHistory();
    } catch (e) {
      this.errorMsg = 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ';
    } finally {
      this.isLoading = false;
    }
  }

  getLunarMonthName(month: number): string {
    return LUNAR_MONTHS[month - 1] || '';
  }

  getLunarDayName(day: number): string {
    return LUNAR_DAYS[day - 1] || '';
  }

  getActiveGuaList(): string[] {
    if (!this.analysis || !this.analysis.huagong) return [];
    // æ ¹æ®åŒ–å·¥åˆ†æè·å–å½“ä»¤å¦
    const seasonElement = this.analysis.huagong.seasonElement;
    const guaList: string[] = [];
    for (const gua of BAGUA_DATA) {
      if (gua.element === seasonElement) {
        guaList.push(gua.name);
      }
    }
    return guaList;
  }

  // è·å–ç”Ÿæœˆå¯¹åº”çš„åŒ–å·¥å›¾é«˜äº®å¦
  getHuagongGuaList(): string[] {
    if (!this.analysis || !this.analysis.benMing) return [];
    const benMingElement = this.analysis.benMing.element;
    const guaList: string[] = [];
    for (const gua of BAGUA_DATA) {
      if (gua.element === benMingElement) {
        guaList.push(gua.name);
      }
    }
    return guaList;
  }

  showGuaDetailDialog(gua: GuaInfo, isYuanqi: boolean): void {
    this.selectedGua = gua;
    this.isYuanqiGua = isYuanqi;
    if (this.guaDialogController) {
      this.guaDialogController.open();
    }
  }

  // ========== å†å²è®°å½•ç›¸å…³æ–¹æ³• ==========

  // åŠ è½½å†å²è®°å½•
  async loadHistory(): Promise<void> {
    this.historyList = await StorageUtil.getHistory();
  }

  // ä¿å­˜å½“å‰æ’ç›˜åˆ°å†å²
  async saveToHistory(): Promise<void> {
    if (!this.analysis || !this.analysis.calendar || !this.analysis.benMing) {
      return;
    }

    const record = new PaipanRecord();
    record.id = Date.now().toString();
    record.gender = this.selectedGender === 0 ? 'ç”·' : 'å¥³';
    record.birthYear = this.selectedYear;
    record.birthMonth = this.selectedMonth;
    record.birthDay = this.selectedDay;
    record.shichenIndex = this.selectedShichen;
    record.lunarDate = `${this.analysis.calendar.lunar_year}å¹´${this.getLunarMonthName(this.analysis.calendar.lunar_month)}æœˆ${this.getLunarDayName(this.analysis.calendar.lunar_day)}`;
    record.benMingGua = this.analysis.benMing.gua;
    record.createTime = Date.now();
    record.name = `${record.gender}Â·${this.selectedYear}å¹´${this.selectedMonth}æœˆ${this.selectedDay}æ—¥`;

    await StorageUtil.saveHistory(record);
    await this.loadHistory();
  }

  // åˆ é™¤å•æ¡å†å²è®°å½•
  async deleteHistory(id: string): Promise<void> {
    await StorageUtil.deleteHistory(id);
    await this.loadHistory();
  }

  // åŠ è½½å†å²è®°å½•
  loadHistoryRecord(record: PaipanRecord): void {
    this.selectedGender = record.gender === 'ç”·' ? 0 : 1;
    this.selectedYear = record.birthYear;
    this.selectedMonth = record.birthMonth;
    this.selectedDay = record.birthDay;
    this.selectedShichen = record.shichenIndex;
    this.showHistoryDialog = false;
    this.doAnalyze();
  }

  // ========== æœ¯è¯­è§£é‡Šç›¸å…³æ–¹æ³• ==========

  // æ˜¾ç¤ºæœ¯è¯­è§£é‡Š
  async showTermExplanation(term: string): Promise<void> {
    if (!this.heluoService) return;
    const explanation = await this.heluoService.getTermExplanation(term);
    if (explanation) {
      this.selectedTerm = explanation;
      this.showTermDialog = true;
    }
  }

  build() {
    Stack() {
      Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('â˜°')
          .fontSize(20)
          .fontColor('#D4AF37')
        Text('æ²³æ´›çœŸæ•°')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#8B0000')
          .margin({ left: 8, right: 8 })
        Text('â˜·')
          .fontSize(20)
          .fontColor('#D4AF37')

        Blank()

        // å†å²è®°å½•æŒ‰é’®
        Row() {
          Text('ğŸ“œ')
            .fontSize(18)
            .margin({ right: 4 })
          Text('å†å²')
            .fontSize(14)
            .fontColor('#8B7355')
        }
        .padding({ left: 10, right: 10, top: 6, bottom: 6 })
        .backgroundColor('#FFF9F0')
        .borderRadius(16)
        .onClick(() => {
          this.showHistoryDialog = true;
        })
        .margin({ right: 12 })
      }
      .width('100%')
      .height(56)
      .padding({ left: 12, right: 12 })
      .backgroundColor('#FFFEF9')
      .border({ width: { bottom: 1 }, color: '#E8DCC8' })

      Scroll() {
        Column() {
          // è¾“å…¥åŒºåŸŸ
          Column() {
            // æ€§åˆ«é€‰æ‹©
            Row() {
              Text('æ€§åˆ«')
                .fontSize(14)
                .fontColor('#4A3728')
                .width(60)

              Row() {
                Row() {
                  Radio({ value: 'male', group: 'gender' })
                    .checked(this.selectedGender === 0)
                    .onChange((isChecked: boolean) => {
                      if (isChecked) this.selectedGender = 0;
                    })
                  Text('ç”·ï¼ˆä¹¾é€ ï¼‰')
                    .fontSize(14)
                    .fontColor('#4A3728')
                    .margin({ left: 4 })
                }

                Row() {
                  Radio({ value: 'female', group: 'gender' })
                    .checked(this.selectedGender === 1)
                    .onChange((isChecked: boolean) => {
                      if (isChecked) this.selectedGender = 1;
                    })
                  Text('å¥³ï¼ˆå¤é€ ï¼‰')
                    .fontSize(14)
                    .fontColor('#4A3728')
                    .margin({ left: 4 })
                }
                .margin({ left: 24 })
              }
            }
            .width('100%')
            .margin({ bottom: 12 })

            // å‡ºç”Ÿå¹´æœˆæ—¥
            Row() {
              Text('é˜³å†')
                .fontSize(14)
                .fontColor('#4A3728')
                .width(60)

              TextInput({ text: this.selectedYear.toString() })
                .type(InputType.Number)
                .width(70)
                .height(36)
                .fontSize(14)
                .fontColor('#4A3728')
                .backgroundColor('#FFFFFF')
                .borderRadius(6)
                .border({ width: 1, color: '#E8DCC8' })
                .onChange((value: string) => {
                  const num = parseInt(value);
                  if (!isNaN(num) && num >= 1900 && num <= 2100) {
                    this.selectedYear = num;
                  }
                })
              Text('å¹´')
                .fontSize(14)
                .fontColor('#4A3728')
                .margin({ left: 4, right: 8 })

              TextInput({ text: this.selectedMonth.toString() })
                .type(InputType.Number)
                .width(50)
                .height(36)
                .fontSize(14)
                .fontColor('#4A3728')
                .backgroundColor('#FFFFFF')
                .borderRadius(6)
                .border({ width: 1, color: '#E8DCC8' })
                .onChange((value: string) => {
                  const num = parseInt(value);
                  if (!isNaN(num) && num >= 1 && num <= 12) {
                    this.selectedMonth = num;
                  }
                })
              Text('æœˆ')
                .fontSize(14)
                .fontColor('#4A3728')
                .margin({ left: 4, right: 8 })

              TextInput({ text: this.selectedDay.toString() })
                .type(InputType.Number)
                .width(50)
                .height(36)
                .fontSize(14)
                .fontColor('#4A3728')
                .backgroundColor('#FFFFFF')
                .borderRadius(6)
                .border({ width: 1, color: '#E8DCC8' })
                .onChange((value: string) => {
                  const num = parseInt(value);
                  if (!isNaN(num) && num >= 1 && num <= 31) {
                    this.selectedDay = num;
                  }
                })
              Text('æ—¥')
                .fontSize(14)
                .fontColor('#4A3728')
                .margin({ left: 4 })
            }
            .width('100%')
            .margin({ bottom: 12 })

            // æ—¶è¾°é€‰æ‹©
            Row() {
              Text('æ—¶è¾°')
                .fontSize(14)
                .fontColor('#4A3728')
                .width(60)

              Select(getShichenOptions())
                .selected(this.selectedShichen)
                .value(SHICHEN_LIST[this.selectedShichen])
                .font({ size: 14 })
                .fontColor('#4A3728')
                .selectedOptionFont({ size: 14 })
                .optionFont({ size: 14 })
                .backgroundColor('#FFFFFF')
                .onSelect((index: number) => {
                  this.selectedShichen = index;
                })
            }
            .width('100%')
            .margin({ bottom: 16 })

            // æ’ç›˜æŒ‰é’®
            Button(this.isLoading ? 'æ¨æ¼”ä¸­...' : 'èµ·  ç›˜')
              .width('100%')
              .height(44)
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FFFFFF')
              .backgroundColor('#8B0000')
              .borderRadius(8)
              .enabled(!this.isLoading)
              .onClick(() => {
                this.doAnalyze();
              })

            if (this.errorMsg !== '') {
              Text(this.errorMsg)
                .fontSize(13)
                .fontColor('#B22222')
                .margin({ top: 8 })
            }
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFEF9')
          .borderRadius(12)
          .margin({ top: 12, left: 12, right: 12 })

          // ç»“æœåŒºåŸŸ
          if (this.hasResult && this.analysis !== null && this.analysis.calendar !== null) {
            // å†œå†ä¿¡æ¯ä¸å››æŸ±
            Column() {
              // å†œå†æ—¥æœŸ
              Row() {
                Text(this.selectedGender === 0 ? 'ä¹¾é€ ' : 'å¤é€ ')
                  .fontSize(14)
                  .fontColor('#D4AF37')
                  .fontWeight(FontWeight.Bold)
                  .margin({ right: 12 })

                Text(`å†œå† ${this.analysis.calendar.year_gan}${this.analysis.calendar.year_zhi}å¹´ ${this.getLunarMonthName(this.analysis.calendar.lunar_month)}æœˆ${this.getLunarDayName(this.analysis.calendar.lunar_day)} ${SHICHEN_NAMES[this.selectedShichen]}æ—¶`)
                  .fontSize(14)
                  .fontColor('#4A3728')
              }
              .width('100%')
              .margin({ bottom: 12 })

              // å››æŸ±æ’ç›˜
              Row() {
                // å¹´æŸ±
                Column() {
                  Text('å¹´æŸ±')
                    .fontSize(11)
                    .fontColor('#8B7355')
                  Text(this.analysis.calendar.year_gan)
                    .fontSize(20)
                    .fontColor('#8B0000')
                    .fontWeight(FontWeight.Bold)
                  Text(this.analysis.calendar.year_zhi)
                    .fontSize(20)
                    .fontColor('#4A3728')
                    .fontWeight(FontWeight.Bold)
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Center)

                // æœˆæŸ±
                Column() {
                  Text('æœˆæŸ±')
                    .fontSize(11)
                    .fontColor('#8B7355')
                  Text(this.analysis.calendar.month_gan)
                    .fontSize(20)
                    .fontColor('#8B0000')
                    .fontWeight(FontWeight.Bold)
                  Text(this.analysis.calendar.month_zhi)
                    .fontSize(20)
                    .fontColor('#4A3728')
                    .fontWeight(FontWeight.Bold)
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Center)

                // æ—¥æŸ±
                Column() {
                  Text('æ—¥æŸ±')
                    .fontSize(11)
                    .fontColor('#8B7355')
                  Text(this.analysis.calendar.day_gan)
                    .fontSize(20)
                    .fontColor('#8B0000')
                    .fontWeight(FontWeight.Bold)
                  Text(this.analysis.calendar.day_zhi)
                    .fontSize(20)
                    .fontColor('#4A3728')
                    .fontWeight(FontWeight.Bold)
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Center)

                // æ—¶æŸ±
                Column() {
                  Text('æ—¶æŸ±')
                    .fontSize(11)
                    .fontColor('#8B7355')
                  Text(this.analysis.calendar.hour_gan)
                    .fontSize(20)
                    .fontColor('#8B0000')
                    .fontWeight(FontWeight.Bold)
                  Text(this.analysis.calendar.hour_zhi)
                    .fontSize(20)
                    .fontColor('#4A3728')
                    .fontWeight(FontWeight.Bold)
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Center)
              }
              .width('100%')
              .padding({ top: 12, bottom: 12 })
              .backgroundColor('#FFF9F0')
              .borderRadius(8)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFEF9')
            .borderRadius(12)
            .margin({ top: 12, left: 12, right: 12 })

            // Tabåˆ†é¡µå¯¼èˆª
            Row() {
              ForEach(['[å®šæ€§]', '[å®šé‡]', '[æµå¹´]'], (tab: string, index: number) => {
                Text(tab)
                  .fontSize(14)
                  .fontWeight(this.currentTabIndex === index ? FontWeight.Bold : FontWeight.Normal)
                  .fontColor(this.currentTabIndex === index ? '#8B0000' : '#8B7355')
                  .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                  .backgroundColor(this.currentTabIndex === index ? '#FFF9F0' : 'transparent')
                  .borderRadius(16)
                  .onClick(() => {
                    this.currentTabIndex = index;
                  })
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceEvenly)
            .padding({ top: 8, bottom: 8 })
            .margin({ top: 12, left: 12, right: 12 })
            .backgroundColor('#FFFEF9')
            .borderRadius(12)

            // ========== Tab0: å®šæ€§åˆ†æ ==========
            if (this.currentTabIndex === 0) {

            // å…ƒæ°”å›¾ - ç”Ÿå¹´å¾—ä¹‹å¤§å‰
            if (this.analysis.benMing !== null) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#D4AF37')
                    .margin({ right: 8 })
                  Text('å…ƒæ°”å›¾ Â· ç”Ÿå¹´å¾—ä¹‹å¤§å‰')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 8 })

                Text(`ç”Ÿå¹´åœ°æ”¯ã€Œ${this.analysis.calendar.year_zhi}ã€è½äºã€Œ${this.analysis.benMing.gua}å¦ã€ï¼Œäº”è¡Œå±${this.analysis.benMing.element}ï¼Œæ•°ç†${this.analysis.benMing.number}`)
                  .fontSize(13)
                  .fontColor('#8B7355')
                  .margin({ bottom: 12 })

                // å…«å¦å›¾ï¼ˆå…ƒæ°”å›¾ï¼‰
                BaguaChart({
                  title: '',
                  highlightGua: this.analysis.benMing.gua,
                  activeGuaList: [],
                  showDetail: $showGuaDetail,
                  selectedGua: $selectedGua
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // åŒ–å·¥ä¹‹å›¾ - ç”Ÿæœˆ
            if (this.analysis.huagong !== null) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#D4AF37')
                    .margin({ right: 8 })
                  Text('åŒ–å·¥ä¹‹å›¾ Â· ç”Ÿæœˆå¾—ä»¤')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 8 })

                Text(`ç”Ÿæœˆåœ°æ”¯ã€Œ${this.analysis.calendar.month_zhi}ã€ï¼Œå½“ä»¤äº”è¡Œã€Œ${this.analysis.huagong.seasonElement}ã€`)
                  .fontSize(13)
                  .fontColor('#8B7355')

                Row() {
                  Text('åŒ–å·¥ç»“æœï¼š')
                    .fontSize(13)
                    .fontColor('#8B7355')
                  Text(`${this.analysis.huagong.type}`)
                    .fontSize(14)
                    .fontColor(this.analysis.huagong.luck === 'å¤§å‰' || this.analysis.huagong.luck === 'å‰' ? '#228B22' :
                      this.analysis.huagong.luck === 'å‡¶' ? '#B22222' : '#4A3728')
                    .fontWeight(FontWeight.Medium)
                  Text(` (${this.analysis.huagong.luck})`)
                    .fontSize(13)
                    .fontColor('#8B7355')
                }
                .margin({ top: 4, bottom: 12 })

                // å…«å¦å›¾ï¼ˆåŒ–å·¥å›¾ï¼‰
                BaguaChart({
                  title: '',
                  highlightGua: this.analysis.benMing?.gua || '',
                  activeGuaList: this.getActiveGuaList(),
                  showDetail: $showGuaDetail,
                  selectedGua: $selectedGua
                })

                // åŒ–å·¥è¯´æ˜
                Text(this.analysis.huagong.desc)
                  .fontSize(13)
                  .fontColor('#4A3728')
                  .margin({ top: 12 })
                  .lineHeight(20)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // æ¸¸å¹´å›¾ - å…«æ–¹å‰å‡¶
            if (this.younianAnalysis.relations.length > 0) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#D4AF37')
                    .margin({ right: 8 })
                  Text('æ¸¸å¹´å›¾ Â· å…«æ–¹å‰å‡¶æŒ‡å—')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 8 })

                Text(`æœ¬å‘½å¦ã€Œ${this.younianAnalysis.benMingGua}å¦ã€é‡å…«æ–¹å„æœ‰å‰å‡¶ï¼Œç‚¹å‡»æ–¹ä½æŸ¥çœ‹è¯¦æƒ…`)
                  .fontSize(13)
                  .fontColor('#8B7355')
                  .margin({ bottom: 12 })

                // æ¸¸å¹´å…«å¦å›¾
                YouNianChart({
                  younianAnalysis: this.younianAnalysis,
                  onGuaClick: (rel: YouNianRelation) => {
                    this.selectedYounianRel = rel;
                    this.showYounianDetail = true;
                  }
                })

                // å‰æ–¹æ¨è
                if (this.younianAnalysis.jiList.length > 0) {
                  Column() {
                    Text('ã€å‰æ–¹æ¨èã€‘')
                      .fontSize(13)
                      .fontColor('#228B22')
                      .fontWeight(FontWeight.Medium)
                      .margin({ bottom: 4 })
                    ForEach(this.younianAnalysis.jiList, (rel: YouNianRelation) => {
                      Row() {
                        Text(`â˜… ${rel.direction}(${rel.targetGua}) - ${rel.star}ï¼š`)
                          .fontSize(12)
                          .fontColor('#4A3728')
                        Text(rel.starInfo?.desc || '')
                          .fontSize(12)
                          .fontColor('#8B7355')
                      }
                      .width('100%')
                      .margin({ top: 2 })
                    })
                  }
                  .width('100%')
                  .alignItems(HorizontalAlign.Start)
                  .margin({ top: 12 })
                  .padding(8)
                  .backgroundColor('#F0FFF0')
                  .borderRadius(6)
                }

                // å‡¶æ–¹æç¤º
                if (this.younianAnalysis.xiongList.length > 0) {
                  Column() {
                    Text('ã€å‡¶æ–¹æç¤ºã€‘')
                      .fontSize(13)
                      .fontColor('#B22222')
                      .fontWeight(FontWeight.Medium)
                      .margin({ bottom: 4 })
                    ForEach(this.younianAnalysis.xiongList, (rel: YouNianRelation) => {
                      Row() {
                        Text(`âš  ${rel.direction}(${rel.targetGua}) - ${rel.star}ï¼š`)
                          .fontSize(12)
                          .fontColor('#4A3728')
                        Text(rel.starInfo?.desc || '')
                          .fontSize(12)
                          .fontColor('#8B7355')
                      }
                      .width('100%')
                      .margin({ top: 2 })
                    })
                  }
                  .width('100%')
                  .alignItems(HorizontalAlign.Start)
                  .margin({ top: 8 })
                  .padding(8)
                  .backgroundColor('#FFF5EE')
                  .borderRadius(6)
                }
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }
            } // ç»“æŸTab0å®šæ€§åˆ†æ

            // ========== Tab1: å®šé‡åˆ†æ ==========
            if (this.currentTabIndex === 1) {

            // æ±‚æ•°æ³• - æ²³æ´›æ•°ç†å¯†ç 
            if (this.qiushuAnalysis.pillars.length > 0) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#D4AF37')
                    .margin({ right: 8 })
                  Text('æ±‚æ•°æ³• Â· æ²³æ´›æ•°ç†å¯†ç ')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 8 })

                Text('å¤©å¹²ç”¨æ²³å›¾æ•°(1-10)ï¼Œåœ°æ”¯ç”¨æ´›ä¹¦æ•°(1-12)ã€‚å¥‡æ•°ä¸ºé˜³å±å·¦ï¼Œå¶æ•°ä¸ºé˜´å±å³ã€‚')
                  .fontSize(12)
                  .fontColor('#8B7355')
                  .margin({ bottom: 12 })

                // æ±‚æ•°æ³•å›¾è¡¨
                QiuShuChart({
                  qiushuAnalysis: this.qiushuAnalysis
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // Aæ³•ï¼šæ­£ç»Ÿæˆå¦æ³•ï¼ˆå…ˆå¤©å‘½å¦ï¼‰
            if (this.zhengTongGua.mingGua.name !== '') {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#8B4513')
                    .margin({ right: 8 })
                  Text('æˆå¦æ³•A Â· å¤©åœ°ä½™æ•°åˆæˆé‡å¦')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                ZhengTongGuaChart({
                  result: this.zhengTongGua
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // Bæ³•ï¼šå¹´å¹²èµ·å¦+åŠ¨çˆ»æ³•ï¼ˆåå¤©å‘½ç›˜ï¼‰
            if (this.nianGanGua.benMingGua.name !== '') {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#1E4D8C')
                    .margin({ right: 8 })
                  Text('æˆå¦æ³•B Â· å¹´å¹²èµ·å¦+åŠ¨çˆ»å˜å¦')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                NianGanGuaChart({
                  result: this.nianGanGua
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // ä½“ç”¨ç»¼åˆåˆ†æ
            if (this.tiYongResult.combinedResult !== '') {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#4A0080')
                    .margin({ right: 8 })
                  Text('ä½“ç”¨åˆå‚ Â· ç»¼åˆæ–­äº‹')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                TiYongAnalysis({
                  tiYong: this.tiYongResult,
                  zhengTong: this.zhengTongGua,
                  nianGan: this.nianGanGua
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }
            } // ç»“æŸTab1å®šé‡åˆ†æ

            // ========== Tab2: æµå¹´è¿åŠ¿ ==========
            if (this.currentTabIndex === 2) {

            // å®šå…ƒå ‚å¼ - å‘½ä¸»åœ¨å¦ä¸­çš„ä½ç½®
            if (this.yuanTangInfo.yaoPosition > 0) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#8B4513')
                    .margin({ right: 8 })
                  Text('å®šå…ƒå ‚å¼ Â· å‘½ä¸»å®šä½')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                Text(`å‡ºç”Ÿæ—¶è¾°ã€Œ${this.yuanTangInfo.shichenName}ã€å…ƒå ‚åœ¨ã€Œ${this.yuanTangInfo.yaoName}ã€`)
                  .fontSize(14)
                  .fontColor('#4A3728')
                  .margin({ bottom: 8 })

                Row() {
                  Text('çˆ»ä½å«ä¹‰ï¼š')
                    .fontSize(13)
                    .fontColor('#8B7355')
                  Text(this.yuanTangInfo.meaning)
                    .fontSize(13)
                    .fontColor('#4A3728')
                }
                .margin({ bottom: 4 })

                Row() {
                  Text('è®¡ç®—è§„åˆ™ï¼š')
                    .fontSize(13)
                    .fontColor('#8B7355')
                  Text(this.yuanTangInfo.calcRule || 'æ‚å¦é˜´é˜³å¾ªç¯')
                    .fontSize(13)
                    .fontColor('#8B7355')
                }
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // èµ·æ—¥å¦ - ä»Šæ—¥è¿åŠ¿
            if (this.liuRiGua.dayZhi !== '') {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#FF8C00')
                    .margin({ right: 8 })
                  Text('èµ·æ—¥å¦ Â· ä»Šæ—¥è¿åŠ¿')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                Row() {
                  Column() {
                    Text('æ—¥æ”¯')
                      .fontSize(12)
                      .fontColor('#8B7355')
                    Text(this.liuRiGua.dayZhi)
                      .fontSize(24)
                      .fontColor('#8B0000')
                      .fontWeight(FontWeight.Bold)
                  }
                  .layoutWeight(1)

                  Column() {
                    Text('æ—¥å¦')
                      .fontSize(12)
                      .fontColor('#8B7355')
                    Text(this.liuRiGua.dayGua)
                      .fontSize(24)
                      .fontColor('#4A3728')
                      .fontWeight(FontWeight.Bold)
                  }
                  .layoutWeight(1)

                  Column() {
                    Text('åŠ¨çˆ»')
                      .fontSize(12)
                      .fontColor('#8B7355')
                    Text(this.liuRiGua.dongYaoName)
                      .fontSize(24)
                      .fontColor('#1E90FF')
                      .fontWeight(FontWeight.Bold)
                  }
                  .layoutWeight(1)

                  Column() {
                    Text('äº”è¡Œ')
                      .fontSize(12)
                      .fontColor('#8B7355')
                    Text(this.liuRiGua.wuxingRelation)
                      .fontSize(20)
                      .fontColor(this.liuRiGua.luck === 'å‰' ? '#228B22' : this.liuRiGua.luck === 'å‡¶' ? '#B22222' : '#4A3728')
                      .fontWeight(FontWeight.Medium)
                  }
                  .layoutWeight(1)
                }
                .width('100%')
                .padding({ top: 8, bottom: 8 })
                .backgroundColor('#FFF9F0')
                .borderRadius(8)

                Text(this.liuRiGua.desc)
                  .fontSize(13)
                  .fontColor('#4A3728')
                  .margin({ top: 12 })
                  .lineHeight(20)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // èµ·æœˆå¦ - 12æœˆæµæœˆè¿åŠ¿
            if (this.liuYueGuaList.length > 0) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#9370DB')
                    .margin({ right: 8 })
                  Text('èµ·æœˆå¦ Â· æµæœˆè¿åŠ¿')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                Text('å…ƒå ‚çˆ»ä½é€æœˆç§»åŠ¨ï¼Œé…åˆæœˆå¦äº”è¡Œç”Ÿå…‹æ–­å‰å‡¶')
                  .fontSize(12)
                  .fontColor('#8B7355')
                  .margin({ bottom: 8 })

                // æœˆä»½åˆ—è¡¨
                Grid() {
                  ForEach(this.liuYueGuaList, (item: LiuYueGuaInfo) => {
                    GridItem() {
                      Column() {
                        Text(`${item.month}æœˆ`)
                          .fontSize(12)
                          .fontColor('#8B7355')
                        Text(item.monthGua)
                          .fontSize(16)
                          .fontColor('#4A3728')
                          .fontWeight(FontWeight.Medium)
                        Text(item.luck)
                          .fontSize(12)
                          .fontColor(item.luck === 'å‰' ? '#228B22' : item.luck === 'å‡¶' ? '#B22222' : '#8B7355')
                      }
                      .padding(6)
                      .backgroundColor(item.luck === 'å‰' ? '#F0FFF0' : item.luck === 'å‡¶' ? '#FFF5F5' : '#FAFAFA')
                      .borderRadius(6)
                    }
                  })
                }
                .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr')
                .rowsGap(8)
                .columnsGap(8)
                .width('100%')
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // å…«å¦ç›¸è¡æ³• - æµå¹´æ¨æ¼”
            if (this.xiangDangResult.benMingGua.name !== '') {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#1E90FF')
                    .margin({ right: 8 })
                  Text('å…«å¦ç›¸è¡ Â· æµå¹´æ¨æ¼”')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                XiangDangChart({ result: this.xiangDangResult })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // å…­äº²çº³ç”²è¡¨æ ¼ - å½“å‰æµå¹´å¦å…­äº²æ—ºè¡°
            if (this.naJiaPan.yaoList.length > 0) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#2F4F4F')
                    .margin({ right: 8 })
                  Text('å…­äº²çº³ç”² Â· æµå¹´å…­çˆ»æ—ºè¡°')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                Text(`æµå¹´å¦ã€Œ${this.naJiaPan.guaName}ã€ï¼Œå±ã€Œ${this.naJiaPan.gong}å®«ã€ï¼Œ${this.getNaJiaTypeName(this.naJiaPan.type)}ï¼›ä¸–çˆ»åœ¨ã€Œ${this.getYaoName(this.naJiaPan.shiYao)}ã€ï¼Œåº”çˆ»åœ¨ã€Œ${this.getYaoName(this.naJiaPan.yingYao)}ã€`)
                  .fontSize(12)
                  .fontColor('#8B7355')
                  .margin({ bottom: 8 })

                // è¡¨å¤´
                Row() {
                  Text('çˆ»ä½')
                    .fontSize(12)
                    .fontColor('#8B7355')
                    .layoutWeight(1)
                  Text('çº³æ”¯')
                    .fontSize(12)
                    .fontColor('#8B7355')
                    .layoutWeight(1)
                  Text('å¤©å¹²')
                    .fontSize(12)
                    .fontColor('#8B7355')
                    .layoutWeight(1)
                  Text('äº”è¡Œ')
                    .fontSize(12)
                    .fontColor('#8B7355')
                    .layoutWeight(1)
                  Text('å…­äº²')
                    .fontSize(12)
                    .fontColor('#8B7355')
                    .layoutWeight(1.2)
                  Text('ä¸–/åº”')
                    .fontSize(12)
                    .fontColor('#8B7355')
                    .layoutWeight(1)
                  Text('æ—ºè¡°')
                    .fontSize(12)
                    .fontColor('#8B7355')
                    .layoutWeight(1.2)
                }
                .width('100%')
                .padding({ top: 6, bottom: 6, left: 8, right: 8 })
                .backgroundColor('#FFF9F0')
                .borderRadius(6)

                // å…­çˆ»æ˜ç»†ï¼Œä»ä¸Šçˆ»åˆ°åˆçˆ»
                Column() {
                  ForEach(this.naJiaPan.yaoList.slice().reverse(), (item: YaoWithNaJia) => {
                    Row() {
                      Text(this.getYaoName(item.index))
                        .fontSize(13)
                        .fontColor('#4A3728')
                        .layoutWeight(1)
                      Text(item.zhi)
                        .fontSize(13)
                        .fontColor('#4A3728')
                        .layoutWeight(1)
                      Text(item.gan)
                        .fontSize(13)
                        .fontColor('#4A3728')
                        .layoutWeight(1)
                      Text(item.element)
                        .fontSize(13)
                        .fontColor('#4A3728')
                        .layoutWeight(1)
                      Text(item.liuQin || '-')
                        .fontSize(13)
                        .fontColor(this.getLiuQinColor(item.liuQin))
                        .layoutWeight(1.2)
                      Text(item.isShi ? 'ä¸–' : item.isYing ? 'åº”' : '')
                        .fontSize(13)
                        .fontColor(item.isShi || item.isYing ? '#8B0000' : '#8B7355')
                        .layoutWeight(1)
                      Text(item.wangShuai || '')
                        .fontSize(13)
                        .fontColor(this.getWangShuaiColor(item.wangShuai))
                        .layoutWeight(1.2)
                    }
                    .width('100%')
                    .padding({ top: 4, bottom: 4, left: 8, right: 8 })
                  })
                }
                .width('100%')
                .backgroundColor('#FFFEF9')
                .borderRadius(6)
                .margin({ top: 4 })

                Text('ä»¥æ—¥å¹²ä¸ºæˆ‘ï¼Œå…­çˆ»çº³ç”²ä¸ºç”¨ï¼šåŒæˆ‘ä¸ºå…„å¼Ÿï¼Œæˆ‘ç”Ÿä¸ºå­å­™ï¼Œç”Ÿæˆ‘ä¸ºçˆ¶æ¯ï¼Œæˆ‘å…‹ä¸ºå¦»è´¢ï¼Œå…‹æˆ‘ä¸ºå®˜é¬¼ï¼›å†ç»“åˆèŠ‚æ°”æ—ºè¡°åˆ¤æ–­æ¯ä¸€çˆ»çš„å‘åŠ›è½»é‡ã€‚')
                  .fontSize(12)
                  .fontColor('#8B7355')
                  .margin({ top: 10 })
                  .lineHeight(18)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }

            // å°è±¡è¡Œå¹´ - å½“å‰å²æ•°è¿åŠ¿
            if (this.xiaoXiangResult.age > 0) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color('#DC143C')
                    .margin({ right: 8 })
                  Text('å°è±¡è¡Œå¹´ Â· æµå¹´å¦æ°”')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                Text(`è™šå²${this.xiaoXiangResult.age}å²ï¼Œå½“å‰è¿åŠ¿åœ¨ã€Œ${this.xiaoXiangResult.currentYaoName}ã€`)
                  .fontSize(14)
                  .fontColor('#4A3728')
                  .margin({ bottom: 12 })

                // å°è±¡æ–­è¯­
                Column() {
                  Row() {
                    Text('çˆ»è¾ï¼š')
                      .fontSize(13)
                      .fontColor('#8B7355')
                    Text(this.xiaoXiangResult.yaoCi)
                      .fontSize(14)
                      .fontColor('#4A3728')
                      .fontWeight(FontWeight.Medium)
                  }
                  .width('100%')
                  .margin({ bottom: 6 })

                  Row() {
                    Text('å°è±¡ï¼š')
                      .fontSize(13)
                      .fontColor('#8B7355')
                    Text(this.xiaoXiangResult.xiaoXiang)
                      .fontSize(14)
                      .fontColor('#4A3728')
                  }
                  .width('100%')
                  .margin({ bottom: 6 })

                  Row() {
                    Text('å‰å‡¶ï¼š')
                      .fontSize(13)
                      .fontColor('#8B7355')
                    Text(this.xiaoXiangResult.luck)
                      .fontSize(16)
                      .fontColor(this.xiaoXiangResult.luck === 'å¤§å‰' || this.xiaoXiangResult.luck === 'å‰' ? '#228B22' :
                        this.xiaoXiangResult.luck === 'å‡¶' ? '#B22222' : '#4A3728')
                      .fontWeight(FontWeight.Bold)
                  }
                  .width('100%')
                }
                .width('100%')
                .padding(12)
                .backgroundColor('#FFF9F0')
                .borderRadius(8)

                // å»ºè®®
                Text(this.xiaoXiangResult.advice)
                  .fontSize(13)
                  .fontColor('#4A3728')
                  .margin({ top: 12 })
                  .lineHeight(20)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .margin({ top: 12, left: 12, right: 12 })
            }
            } // ç»“æŸTab2æµå¹´è¿åŠ¿

            // åŒ–å·¥ç›¸åä¹‹å›¾ - åå±€æ£€æµ‹ï¼ˆæ”¾åœ¨æ‰€æœ‰Tabå¤–ä½œä¸ºè­¦å‘Šï¼‰
            if (this.analysis.fanju !== null) {
              Column() {
                Row() {
                  Divider()
                    .vertical(true)
                    .height(16)
                    .strokeWidth(3)
                    .color(this.analysis.fanju.triggered ? '#B22222' : '#D4AF37')
                    .margin({ right: 8 })
                  Text('åŒ–å·¥ç›¸åä¹‹å›¾ Â· åå±€æ£€æµ‹')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#4A3728')
                }
                .width('100%')
                .margin({ bottom: 12 })

                Row() {
                  if (this.analysis.fanju.triggered) {
                    Text('âš ')
                      .fontSize(18)
                      .fontColor('#B22222')
                    Text(' è§¦å‘åå±€')
                      .fontSize(15)
                      .fontColor('#B22222')
                      .fontWeight(FontWeight.Medium)
                  } else {
                    Text('âœ“')
                      .fontSize(18)
                      .fontColor('#228B22')
                    Text(' æ— åå±€')
                      .fontSize(15)
                      .fontColor('#228B22')
                      .fontWeight(FontWeight.Medium)
                  }
                }
                .margin({ bottom: 8 })

                Text(this.analysis.fanju.desc)
                  .fontSize(13)
                  .fontColor('#4A3728')
                  .lineHeight(20)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFEF9')
              .borderRadius(12)
              .border({ width: 1, color: this.analysis.fanju.triggered ? '#B22222' : '#E8DCC8' })
              .margin({ top: 12, left: 12, right: 12 })
            }

            // ç»¼åˆè¯„ä¼°
            Column() {
              Row() {
                Divider()
                  .vertical(true)
                  .height(16)
                  .strokeWidth(3)
                  .color('#D4AF37')
                  .margin({ right: 8 })
                Text('ç»¼åˆè¯„ä¼°')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#4A3728')
              }
              .width('100%')
              .margin({ bottom: 12 })

              Text(this.analysis.summary)
                .fontSize(14)
                .fontColor('#4A3728')
                .lineHeight(22)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFEF9')
            .borderRadius(12)
            .border({ width: 2, color: '#D4AF37' })
            .margin({ top: 12, left: 12, right: 12, bottom: 24 })
          }
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor('#FDF8F0')
      .align(Alignment.Top)
    }
    .width('100%')
    .height('100%')
    .bindSheet($$this.showGuaDetail, this.GuaDetailSheet(), {
      height: SheetSize.FIT_CONTENT,
      backgroundColor: '#FFFEF9',
      showClose: true
    })
    .bindSheet($$this.showYounianDetail, this.YouNianDetailSheet(), {
      height: SheetSize.FIT_CONTENT,
      backgroundColor: '#FFFEF9',
      showClose: true
    })

      // å†å²è®°å½•å¼¹çª—
      if (this.showHistoryDialog) {
        Column() {
          Column() {
            this.HistoryDialogSheet()
          }
          .width('90%')
          .backgroundColor('#FFFEF9')
          .borderRadius(16)
          .shadow({ radius: 20, color: '#00000030' })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#00000080')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showHistoryDialog = false;
        })
      }

      // æœ¯è¯­è§£é‡Šå¼¹çª—
      if (this.showTermDialog) {
        Column() {
          Column() {
            this.TermDialogSheet()
          }
          .width('90%')
          .backgroundColor('#FFFEF9')
          .borderRadius(16)
          .shadow({ radius: 20, color: '#00000030' })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#00000080')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showTermDialog = false;
        })
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  YouNianDetailSheet() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text(this.selectedYounianRel.star)
          .fontSize(28)
          .fontColor(this.getStarColor(this.selectedYounianRel.starInfo?.luck || ''))
          .fontWeight(FontWeight.Bold)
        Column() {
          Text(`${this.selectedYounianRel.direction} Â· ${this.selectedYounianRel.targetGua}å¦`)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#4A3728')
          Text(this.selectedYounianRel.starInfo?.luck || '')
            .fontSize(14)
            .fontColor(this.getStarColor(this.selectedYounianRel.starInfo?.luck || ''))
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 16 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 20 })

      // äº”è¡Œå±æ€§
      Row() {
        Text('äº”è¡Œï¼š')
          .fontSize(14)
          .fontColor('#8B7355')
        Text(this.selectedYounianRel.starInfo?.element || '')
          .fontSize(16)
          .fontColor('#4A3728')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // è¯¦ç»†æè¿°
      Column() {
        Text('è¯¦ç»†è¯´æ˜ï¼š')
          .fontSize(14)
          .fontColor('#8B7355')
          .margin({ bottom: 8 })
        Text(this.selectedYounianRel.starInfo?.desc || '')
          .fontSize(14)
          .fontColor('#4A3728')
          .lineHeight(22)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 16 })

      // åº”ç”¨å»ºè®®
      Column() {
        Divider().color('#E8DCC8').margin({ bottom: 12 })
        Text('åº”ç”¨å»ºè®®ï¼š')
          .fontSize(14)
          .fontColor('#D4AF37')
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })
        Text(this.getYounianAdvice(this.selectedYounianRel.star))
          .fontSize(13)
          .fontColor('#4A3728')
          .lineHeight(20)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(24)
  }

  getStarColor(luck: string): string {
    if (luck === 'å¤§å‰') return '#D4AF37';
    if (luck === 'ä¸­å‰') return '#228B22';
    if (luck === 'å°å‰') return '#32CD32';
    if (luck === 'å¤§å‡¶') return '#8B0000';
    if (luck === 'æ¬¡å‡¶') return '#B22222';
    if (luck === 'å°å‡¶') return '#CD853F';
    return '#666666';
  }

  getYounianAdvice(starName: string): string {
    const advices = new Map<string, string>([
      ['ç”Ÿæ°”', 'æ­¤æ–¹ä½å¤§å‰ï¼Œé€‚åˆèµ·å±…ã€åŠå…¬ã€å¼€åº—ã€‚äººé™…å…³ç³»ä¸­é‡æ­¤å¦äººï¼Œåˆä½œé †åˆ©ï¼Œäº‹ä¸šå…´æ—ºã€‚'],
      ['å¤©åŒ»', 'æ­¤æ–¹ä½å‰åˆ©ï¼Œé€‚åˆå…»ç”Ÿåº·å¤ï¼Œå¸¸å¾—è´µäººç›¸åŠ©ã€‚èº«ä½“æ¬ ä½³æ—¶ï¼Œå¯æœæ­¤æ–¹å¯»åŒ»é—®è¯ã€‚'],
      ['å»¶å¹´', 'æ­¤æ–¹ä½ä¸»å’Œç¾ç¼˜åˆ†ï¼Œé€‚åˆå§»å§»äº¤å‹ã€‚åˆä½œã€å©šå§»ä¹‹äº‹é‡æ­¤å¦äººï¼Œé•¿ä¹…å’Œç¦ã€‚'],
      ['ä¼ä½', 'æ­¤æ–¹ä½ä¸»å¹³ç¨³ï¼Œå®ˆæˆåˆ™å‰ï¼Œæ±‚å˜åˆ™éš¾ã€‚é€‚åˆä¿æŒç°çŠ¶ï¼Œè“„åŠ¿å¾…å‘ã€‚'],
      ['ç»å‘½', 'æ­¤æ–¹ä½å¤§å‡¶ï¼Œå®œå›é¿ï¼Œä¸å®œä¹…ç•™ã€‚é‡å¤§å†³ç­–ã€èµ„äº§é…ç½®åº”é¿å¼€æ­¤æ–¹ã€‚'],
      ['äº”é¬¼', 'æ­¤æ–¹ä½ä¸»å£èˆŒæ˜¯éï¼Œå°äººä½œç¥–ã€‚åº”é¿å…åœ¨æ­¤æ–¹ä½è°ˆåˆ¤æˆ–ç­¾çº¦ï¼Œé˜²ç«ç¾ã€‚'],
      ['å…­ç…', 'æ­¤æ–¹ä½ä¸»æ¡ƒèŠ±çº çº·ï¼Œåå¤æ— å¸¸ã€‚æ„Ÿæƒ…ã€åˆä½œä¸å®œåœ¨æ­¤æ–¹ä½å®šå±€ï¼Œæ˜“ç”Ÿå˜æ•°ã€‚'],
      ['ç¥¸å®³', 'æ­¤æ–¹ä½ä¸»è€—æŸï¼Œèº«ä½“æ˜“èµ°å¼±ã€‚ä¸å®œåœ¨æ­¤æ–¹è¿›è¡Œå¥åº·ç›¸å…³æ´»åŠ¨ï¼Œé˜²å°äººã€‚']
    ]);
    return advices.get(starName) || 'æš‚æ— è¯¦ç»†å»ºè®®';
  }

  getYaoName(index: number): string {
    const names: string[] = ['åˆçˆ»', 'äºŒçˆ»', 'ä¸‰çˆ»', 'å››çˆ»', 'äº”çˆ»', 'ä¸Šçˆ»'];
    if (index >= 1 && index <= 6) {
      return names[index - 1];
    }
    return '';
  }

  getNaJiaTypeName(type: string): string {
    switch (type) {
      case 'pure':
        return 'å…«çº¯å¦';
      case 'one_shi':
        return 'ä¸€ä¸–å¦';
      case 'two_shi':
        return 'äºŒä¸–å¦';
      case 'three_shi':
        return 'ä¸‰ä¸–å¦';
      case 'four_shi':
        return 'å››ä¸–å¦';
      case 'five_shi':
        return 'äº”ä¸–å¦';
      case 'you_hun':
        return 'æ¸¸é­‚å¦';
      case 'gui_hun':
        return 'å½’é­‚å¦';
      default:
        return '';
    }
  }

  getLiuQinColor(liuQin: string): string {
    if (liuQin === 'å®˜é¬¼') return '#B22222';
    if (liuQin === 'å¦»è´¢') return '#8B4513';
    if (liuQin === 'å­å­™') return '#228B22';
    if (liuQin === 'çˆ¶æ¯') return '#1E90FF';
    if (liuQin === 'å…„å¼Ÿ') return '#4A3728';
    return '#4A3728';
  }

  getWangShuaiColor(type: string): string {
    if (type === 'ç”ŸåŠ©' || type === 'æ¯”åŠ©') return '#228B22';
    if (type === 'å…‹åˆ¶') return '#B22222';
    if (type === 'å…‹è´¢' || type === 'æ³„è€—') return '#CD853F';
    return '#4A3728';
  }

  @Builder
  GuaDetailSheet() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text(this.selectedGua.symbol)
          .fontSize(48)
          .fontColor('#8B0000')
        Column() {
          Text(`${this.selectedGua.name}å¦`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4A3728')
          Text(`${this.selectedGua.direction} Â· ${this.selectedGua.element}`)
            .fontSize(14)
            .fontColor('#8B7355')
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 16 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 20 })

      // æ•°å­—
      Row() {
        Text('æ•°å­—ï¼š')
          .fontSize(14)
          .fontColor('#8B7355')
        Text(`${this.selectedGua.number}`)
          .fontSize(20)
          .fontColor('#D4AF37')
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // å¤©å¹²
      Row() {
        Text('å¤©å¹²ï¼š')
          .fontSize(14)
          .fontColor('#8B7355')
        Text(this.selectedGua.tiangan.length > 0 ? this.selectedGua.tiangan.join('ã€') : '-')
          .fontSize(16)
          .fontColor('#4A3728')
      }
      .width('100%')
      .margin({ bottom: 12 })

      // åœ°æ”¯
      Row() {
        Text('åœ°æ”¯ï¼š')
          .fontSize(14)
          .fontColor('#8B7355')
        Text(this.selectedGua.dizhi.length > 0 ? this.selectedGua.dizhi.join('ã€') : '-')
          .fontSize(16)
          .fontColor('#4A3728')
      }
      .width('100%')
      .margin({ bottom: 12 })

      // è§£é‡Š
      Column() {
        Text('è§£é‡Šï¼š')
          .fontSize(14)
          .fontColor('#8B7355')
          .margin({ bottom: 8 })
        Text(this.selectedGua.desc)
          .fontSize(14)
          .fontColor('#4A3728')
          .lineHeight(22)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 16 })

      // çº³ç”²åŸç†
      Column() {
        Divider().color('#E8DCC8').margin({ bottom: 12 })
        Text('çº³ç”²åŸç†ï¼š')
          .fontSize(14)
          .fontColor('#D4AF37')
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })
        Text(this.getNajiaPrinciple(this.selectedGua.name))
          .fontSize(13)
          .fontColor('#4A3728')
          .lineHeight(20)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(24)
  }

  getNajiaPrinciple(guaName: string): string {
    const principles = new Map<string, string>([
      ['ä¹¾', 'ä¹¾å¦ç»Ÿé¢†ç”²ã€å£¬ä¸¤ä¸ªå¤©å¹²ã€‚æˆŒäº¥æ˜¯ç«‹å†¬å‰çš„æœˆä»½ï¼Œä»£è¡¨è¥¿åŒ—ï¼Œæ˜¯ä¹¾å¦çš„"è€å®¶"ï¼ˆä¹¾å±…è¥¿åŒ—ï¼‰ã€‚åœ¨æ²³å›¾æ´›ä¹¦ä¸­ï¼Œä¹¾ä¸ºå¤©ï¼Œå¤©ä¸€ç”Ÿæ°´ï¼Œåœ°å…­æˆä¹‹ï¼Œä¹¾å¦å¯¹åº”æ´›ä¹¦çš„"å…­ç™½"æ˜Ÿï¼Œäº”è¡Œå±é‡‘ï¼Œæ•…å–æ•°6ã€‚'],
      ['å¤', 'å¤å¦ç»Ÿé¢†å·±ã€ç™¸ä¸¤ä¸ªå¤©å¹²ã€‚æœªç”³æ˜¯ç«‹ç§‹å‰çš„æœˆä»½ï¼Œä»£è¡¨è¥¿å—ï¼Œæ˜¯å¤å¦çš„æœ¬ä½ã€‚å¤ä¸ºåœ°ï¼Œå¯¹åº”æ´›ä¹¦"äºŒé»‘"æ˜Ÿï¼Œäº”è¡Œå±åœŸï¼Œæ•…å–æ•°2ã€‚'],
      ['éœ‡', 'éœ‡å¦ç»Ÿé¢†åºšå¤©å¹²ã€‚å¯æ˜¯æ˜¥åˆ†å‰åçš„æœˆä»½ï¼Œä»£è¡¨æ­£ä¸œï¼Œæ˜¯éœ‡å¦çš„æœ¬ä½ã€‚éœ‡ä¸ºé›·ï¼Œå¯¹åº”æ´›ä¹¦"ä¸‰ç¢§"æ˜Ÿï¼Œäº”è¡Œå±æœ¨ï¼Œæ•…å–æ•°3ã€‚'],
      ['å·½', 'å·½å¦ç»Ÿé¢†è¾›å¤©å¹²ã€‚è¾°å·³æ˜¯ç«‹å¤å‰çš„æœˆä»½ï¼Œä»£è¡¨ä¸œå—ï¼Œæ˜¯å·½å¦çš„æœ¬ä½ã€‚å·½ä¸ºé£ï¼Œå¯¹åº”æ´›ä¹¦"å››ç»¿"æ˜Ÿï¼Œäº”è¡Œå±æœ¨ï¼Œæ•…å–æ•°4ã€‚'],
      ['å', 'åå¦ç»Ÿé¢†æˆŠå¤©å¹²ã€‚å­æ˜¯å†¬è‡³å‰åçš„æœˆä»½ï¼Œä»£è¡¨æ­£åŒ—ï¼Œæ˜¯åå¦çš„æœ¬ä½ã€‚åä¸ºæ°´ï¼Œå¯¹åº”æ´›ä¹¦"ä¸€ç™½"æ˜Ÿï¼Œäº”è¡Œå±æ°´ï¼Œæ•…å–æ•°1ã€‚'],
      ['ç¦»', 'ç¦»å¦ç»Ÿé¢†å·±å¤©å¹²ã€‚åˆæ˜¯å¤è‡³å‰åçš„æœˆä»½ï¼Œä»£è¡¨æ­£å—ï¼Œæ˜¯ç¦»å¦çš„æœ¬ä½ã€‚ç¦»ä¸ºç«ï¼Œå¯¹åº”æ´›ä¹¦"ä¹ç´«"æ˜Ÿï¼Œäº”è¡Œå±ç«ï¼Œæ•…å–æ•°9ã€‚'],
      ['è‰®', 'è‰®å¦ç»Ÿé¢†ä¸™å¤©å¹²ã€‚ä¸‘å¯…æ˜¯ç«‹æ˜¥å‰çš„æœˆä»½ï¼Œä»£è¡¨ä¸œåŒ—ï¼Œæ˜¯è‰®å¦çš„æœ¬ä½ã€‚è‰®ä¸ºå±±ï¼Œå¯¹åº”æ´›ä¹¦"å…«ç™½"æ˜Ÿï¼Œäº”è¡Œå±åœŸï¼Œæ•…å–æ•°8ã€‚'],
      ['å…‘', 'å…‘å¦ç»Ÿé¢†ä¸å¤©å¹²ã€‚é…‰æ˜¯ç§‹åˆ†å‰åçš„æœˆä»½ï¼Œä»£è¡¨æ­£è¥¿ï¼Œæ˜¯å…‘å¦çš„æœ¬ä½ã€‚å…‘ä¸ºæ³½ï¼Œå¯¹åº”æ´›ä¹¦"ä¸ƒèµ¤"æ˜Ÿï¼Œäº”è¡Œå±é‡‘ï¼Œæ•…å–æ•°7ã€‚']
    ]);
    return principles.get(guaName) || 'æš‚æ— è¯¦ç»†è¯´æ˜';
  }

  @Builder
  HistoryDialogSheet() {
    Column() {
      // æ ‡é¢˜
      Text('ğŸ“œ æ’ç›˜å†å²')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#8B0000')
        .margin({ bottom: 16 })

      if (this.historyList.length === 0) {
        Column() {
          Text('ğŸ“„')
            .fontSize(48)
            .margin({ bottom: 12 })
          Text('æš‚æ— å†å²è®°å½•')
            .fontSize(14)
            .fontColor('#8B7355')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column() {
            ForEach(this.historyList, (item: PaipanRecord) => {
              Column() {
                Row() {
                  Column() {
                    Text(item.name)
                      .fontSize(15)
                      .fontColor('#4A3728')
                      .fontWeight(FontWeight.Medium)
                    Text(`${item.lunarDate} Â· ${SHICHEN_NAMES[item.shichenIndex]}æ—¶`)
                      .fontSize(12)
                      .fontColor('#8B7355')
                      .margin({ top: 4 })
                    Text(`å…ƒæ°”ï¼š${item.benMingGua}å¦`)
                      .fontSize(12)
                      .fontColor('#D4AF37')
                      .margin({ top: 4 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)

                  Column() {
                    Button('åŠ è½½')
                      .fontSize(12)
                      .width(50)
                      .height(28)
                      .backgroundColor('#8B7355')
                      .onClick(() => {
                        this.loadHistoryRecord(item);
                      })
                    Button('åˆ é™¤')
                      .fontSize(12)
                      .width(50)
                      .height(28)
                      .backgroundColor('#CD853F')
                      .margin({ top: 6 })
                      .onClick(() => {
                        this.deleteHistory(item.id);
                      })
                  }
                }
                .width('100%')
                .padding(14)
                .backgroundColor('#FFFEF9')
                .borderRadius(10)
                .border({ width: 1, color: '#E8DCC8' })
              }
              .width('100%')
              .margin({ bottom: 10 })
            })
          }
        }
        .width('100%')
        .height(400)
      }
    }
    .width('100%')
    .padding(20)
  }

  @Builder
  TermDialogSheet() {
    Column() {
      if (this.selectedTerm) {
        // æ ‡é¢˜
        Text(`ğŸ“– ${this.selectedTerm.term}`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#8B0000')
          .margin({ bottom: 12 })

        Scroll() {
          Column() {
            // åˆ†ç±»
            Row() {
              Text(`ã€${this.selectedTerm.category}ã€‘`)
                .fontSize(12)
                .fontColor('#FFFFFF')
                .backgroundColor('#D4AF37')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(4)
            }
            .width('100%')
            .margin({ bottom: 12 })

            // ç®€è¿°
            Text(this.selectedTerm.shortDesc)
              .fontSize(14)
              .fontColor('#8B7355')
              .lineHeight(22)
              .margin({ bottom: 16 })

            Divider().color('#E8DCC8').margin({ bottom: 16 })

            // è¯¦ç»†è§£é‡Š
            Column() {
              Text('è¯¦ç»†è§£é‡Šï¼š')
                .fontSize(14)
                .fontColor('#D4AF37')
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 8 })
              Text(this.selectedTerm.detailDesc)
                .fontSize(14)
                .fontColor('#4A3728')
                .lineHeight(24)
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // ä¸¾ä¾‹
            if (this.selectedTerm.example) {
              Column() {
                Text('ä¸¾ä¾‹è¯´æ˜ï¼š')
                  .fontSize(14)
                  .fontColor('#D4AF37')
                  .fontWeight(FontWeight.Medium)
                  .margin({ bottom: 8 })
                Text(this.selectedTerm.example)
                  .fontSize(13)
                  .fontColor('#8B7355')
                  .lineHeight(22)
                  .backgroundColor('#FFF9F0')
                  .padding(12)
                  .borderRadius(8)
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 16 })
            }

            // ç›¸å…³æœ¯è¯­
            if (this.selectedTerm.relatedTerms.length > 0) {
              Column() {
                Text('ç›¸å…³æœ¯è¯­ï¼š')
                  .fontSize(14)
                  .fontColor('#D4AF37')
                  .fontWeight(FontWeight.Medium)
                  .margin({ bottom: 8 })
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.selectedTerm.relatedTerms, (relatedTerm: string) => {
                    Text(relatedTerm)
                      .fontSize(12)
                      .fontColor('#8B7355')
                      .backgroundColor('#FFFEF9')
                      .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                      .borderRadius(12)
                      .border({ width: 1, color: '#E8DCC8' })
                      .margin({ right: 8, bottom: 8 })
                  })
                }
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
            }
          }
        }
        .width('100%')
        .height(500)
      }
    }
    .width('100%')
    .padding(20)
  }
}
