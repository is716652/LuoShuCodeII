# 河洛真数 - 项目综述

> 基于鸿蒙OS（HarmonyOS）ArkTS开发的河洛理数命理分析应用

---

## 一、项目概述

### 1.1 项目定位
本项目是一款基于《皇极经世》《河洛真数》等古籍的命理分析工具，实现了从**定性（元气、化工、游年）**到**定量（求数、成卦、体用）**再到**流年（八卦相荡、定元堂式、起月卦、起日卦、小象行年）**的完整河洛数卦体系。

### 1.2 技术栈
- **平台**：HarmonyOS 5.0+
- **语言**：ArkTS (TypeScript变体)
- **框架**：ArkUI声明式UI
- **架构**：MVVM模式（Model-View-ViewModel）

### 1.3 核心理念
```
四柱 → 求数 → 成卦 → 断事
  ↓       ↓       ↓       ↓
输入   数理密码  卦象生成  综合分析
```

---

## 二、项目结构

```
LuoShuCodeII/
├── entry/src/main/
│   ├── ets/
│   │   ├── entryability/          # 应用入口
│   │   │   └── EntryAbility.ets
│   │   ├── pages/                 # 页面
│   │   │   └── Index.ets          # 主页面
│   │   ├── components/            # UI组件
│   │   │   ├── BaguaChart.ets     # 八卦图组件
│   │   │   ├── YouNianChart.ets   # 游年图组件
│   │   │   ├── QiuShuChart.ets    # 求数法组件
│   │   │   ├── ZhengTongGuaChart.ets  # A法成卦组件
│   │   │   ├── NianGanGuaChart.ets    # B法成卦组件
│   │   │   └── TiYongAnalysis.ets     # 体用分析组件
│   │   ├── service/               # 服务层
│   │   │   └── HeluoService.ets   # 核心计算服务
│   │   └── model/                 # 数据模型
│   │       └── HeluoModels.ets    # 所有数据类定义
│   └── resources/
│       └── rawfile/
│           ├── calendar/          # 万年历数据
│           │   └── calendar_data_xxxx.json
│           └── rules/             # 规则文件
│               ├── zhengju_rules.json      # 正局规则
│               ├── fanju_rules.json        # 反局规则
│               ├── huagong_rules.json      # 化工规则
│               ├── huagong_xiangfan_rules.json  # 化工相反规则
│               ├── younian_rules.json      # 游年规则
│               ├── qiushu_rules.json       # 求数法规则
│               └── chengua_rules.json      # 成卦法规则
└── 规则/                          # 规则文档（开发参考）
    └── 定量/
        ├── 1.河洛理数求数法.md
        ├── 2.河洛真数正统成卦法.md
        ├── 3.民间成卦法-年干起卦+动爻法.md
        └── 4.两种成卦法的结合应用.md
```

---

## 三、功能模块

### 3.1 模块总览

| 序号 | 模块名称 | 类型 | 功能描述 | 状态 |
|------|---------|------|---------|------|
| 1 | 四柱生成 | 基础 | 年月日时柱干支计算 | ✅ 已完成 |
| 2 | 元气图 | 定性 | 生年得之大吉/大凶判断 | ✅ 已完成 |
| 3 | 化工之图 | 定性 | 生月得令/失令分析 | ✅ 已完成 |
| 4 | 化工相反之图 | 定性 | 反局检测 | ✅ 已完成 |
| 5 | 游年图 | 定性 | 八方吉凶指南 | ✅ 已完成 |
| 6 | 求数法 | 定量 | 四柱转河洛数理 | ✅ 已完成 |
| 7 | 成卦法A | 定量 | 天地余数合成重卦（先天命卦） | ✅ 已完成 |
| 8 | 成卦法B | 定量 | 年干起卦+动爻变卦（后天命盘） | ✅ 已完成 |
| 9 | 体用综合 | 定量 | 体用合参断事 | ✅ 已完成 |
| 10 | 八卦相荡法 | 流年 | 推演流年运势（10年） | ✅ 已完成 |
| 11 | 定元堂式 | 流年 | 命主在卦中的位置 | ✅ 已完成 |
| 12 | 起月卦 | 流年 | 12个月流月运势 | ✅ 已完成 |
| 13 | 起日卦 | 流年 | 今日运势 | ✅ 已完成 |
| 14 | 小象行年卦气 | 流年 | 当前虚岁运势 | ✅ 已完成 |

### 3.2 功能流程图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户输入                              │
│         公历年月日 + 时辰 + 性别                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      四柱生成                                │
│    年柱(年干支) + 月柱(月干支) + 日柱(日干支) + 时柱(时干支)   │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
      ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
      │   元气图     │ │  化工之图    │ │   游年图    │
      │ (生年本命卦) │ │ (生月得令)   │ │ (八方吉凶)  │
      └─────────────┘ └─────────────┘ └─────────────┘
              │               │               │
              └───────────────┼───────────────┘
                              │
                              ▼ 【定性 → 定量】
┌─────────────────────────────────────────────────────────────┐
│                       求数法                                 │
│    天干→河图数(1-10)  地支→洛书数(1-12)  分阴阳归类           │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
      ┌─────────────────┐           ┌─────────────────┐
      │   成卦法A（体）   │           │   成卦法B（用）   │
      │ 天地余数合成重卦  │           │ 年干起卦+动爻法   │
      │   → 先天命卦     │           │   → 后天命盘     │
      └─────────────────┘           └─────────────────┘
              │                               │
              └───────────────┬───────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     体用综合分析                             │
│      体卦管“能不能成”  用卦管“怎么成、何时成”                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ 【定量 → 流年】
      ┌─────────────────────────────────────────────┐
      │        流年运势分析（Tab分页）              │
      │  - 八卦相荡法：本命卦×流年卦，推10年运势      │
      │  - 定元堂式：命主在卦中的位置                │
      │  - 起月卦：12个月流月运势                      │
      │  - 起日卦：今日运势                              │
      │  - 小象行年：当前虚岁运势（爵辞、小象辞）    │
      └─────────────────────────────────────────────┘
```

---

## 四、数据模型

### 4.1 核心数据类

```typescript
// 万年历数据
class CalendarData {
  date: string          // 公历日期 "YYYY-MM-DD"
  year/month/day: number
  lunar_year/month/day: number  // 农历
  zodiac: string        // 生肖
  year_gan/zhi: string  // 年柱
  month_gan/zhi: string // 月柱
  day_gan/zhi: string   // 日柱
  hour_gan/zhi: string  // 时柱（计算得出）
  solar_term: string    // 节气
}

// 求数法结果
class QiuShuAnalysis {
  pillars: PillarNumber[]  // 四柱数理
  yangSum: number          // 天数和（奇数之和）
  yinSum: number           // 地数和（偶数之和）
  totalSum: number         // 总数
  pattern: string          // 格局：阳盛/阳偏/阴偏/阴盛
}

// A法成卦结果
class ZhengTongGuaResult {
  tianShuSum: number       // 天数和
  diShuSum: number         // 地数和
  tianYu: number           // 天数余
  diYu: number             // 地数余
  upperGua: DanGuaInfo     // 上卦
  lowerGua: DanGuaInfo     // 下卦
  mingGua: ChongGuaInfo    // 先天命卦
}

// B法成卦结果
class NianGanGuaResult {
  benMingGua: DanGuaInfo   // 本命卦（体）
  totalSum: number         // 四柱总数
  dongYao: number          // 动爻位置(1-6)
  bianGua: ChongGuaInfo    // 变卦（用）
  yuanTang: number         // 元堂爻位
}

// 体用综合结果
class TiYongAnalysisResult {
  tiLuck: string           // 体卦吉凶
  yongLuck: string         // 用卦吉凶
  combinedResult: string   // 综合：大吉/中平/大凶
  advice: string           // 行动建议
}

// 八卦相荡结果
class XiangDangResult {
  benMingGua: ChongGuaInfo  // 本命卦
  mingGeType: string        // 命格类型：阳命男/阴命女等
  liuNianList: LiuNianGuaInfo[]  // 流年卦列表
  currentYear: number       // 当前年份
  tiYongRelation: TiYongRelation // 体用关系
}

// 元堂信息
class YuanTangInfo {
  yaoPosition: number      // 元堂爻位(1-6)
  yaoName: string          // 爻名
  meaning: string          // 爻位含义
  calcRule: string         // 计算规则
}

// 起月卦结果
class LiuYueGuaInfo {
  month: number            // 月份(1-12)
  monthGua: string         // 月卦
  zhuYao: number           // 主爻位
  wuxingRelation: string   // 五行关系
  luck: string             // 吉凶
}

// 起日卦结果
class LiuRiGuaInfo {
  dayZhi: string           // 日支
  dayGua: string           // 日卦
  dongYao: number          // 动爻位
  wuxingRelation: string   // 五行关系
  luck: string             // 吉凶
}

// 小象行年结果
class XiaoXiangResult {
  age: number              // 虚岁
  currentYao: number       // 当前爻位
  yaoCi: string            // 爻辞
  xiaoXiang: string        // 小象辞
  luck: string             // 吉凶
  advice: string           // 建议
}
```

### 4.2 规则数据文件

| 文件 | 用途 | 关键字段 |
|------|------|---------|
| `zhengju_rules.json` | 正局（元气图） | gua, element, dizhi, tiangan |
| `fanju_rules.json` | 反局检测 | trigger_gan, trigger_zhi, fan_gua |
| `huagong_rules.json` | 化工得令 | element, months, start_jieqi |
| `younian_rules.json` | 游年八星 | gua, relations, star |
| `qiushu_rules.json` | 求数法 | hetu_map, luoshu_map |
| `chengua_rules.json` | 成卦法 | luoshu_gua_map, niangan_gua_map, chonggua_64 |

---

## 五、核心算法

### 5.1 时柱计算（五鼠遁时法）

```typescript
// 根据日干和时辰计算时干
function calculateHourGan(dayGan: string, shichenIndex: number): string {
  // 五鼠遁时口诀：
  // 甲己之日：甲子起时（时干从0开始）
  // 乙庚之日：丙子起时（时干从2开始）
  // 丙辛之日：戊子起时（时干从4开始）
  // 丁壬之日：庚子起时（时干从6开始）
  // 戊癸之日：壬子起时（时干从8开始）
  
  const startGanMap = {
    '甲': 0, '己': 0,
    '乙': 2, '庚': 2,
    '丙': 4, '辛': 4,
    '丁': 6, '壬': 6,
    '戊': 8, '癸': 8
  };
  const hourGanIndex = (startGanMap[dayGan] + shichenIndex) % 10;
  return TIAN_GAN[hourGanIndex];
}
```

### 5.2 求数法

```typescript
// 天干取河图数
function getHetuNumber(gan: string): number {
  return TIAN_GAN.indexOf(gan) + 1;  // 甲1...癸10
}

// 地支取洛书数（自然序数）
function getLuoshuNumber(zhi: string): number {
  return DI_ZHI.indexOf(zhi) + 1;    // 子1...亥12
}
```

### 5.3 成卦法A（古法天地余数）

```typescript
// 依据《皇极经世》："天数积而满二十五，则复归于一。"
// 只有"满"了才减去，不满就按实际数用

function calculateTianYu(tianShuSum: number): number {
  let tianYu: number;
  if (tianShuSum >= 25) {
    // 满数情况：和 - 25，若 ≥10 则取个位
    tianYu = tianShuSum - 25;
    if (tianYu >= 10) tianYu = tianYu % 10;
  } else {
    // 不满数情况：直接取个位数
    tianYu = tianShuSum % 10;
  }
  if (tianYu === 0) tianYu = 10;  // 余0视为10
  return tianYu;
}

function calculateDiYu(diShuSum: number): number {
  let diYu: number;
  if (diShuSum >= 30) {
    diYu = diShuSum - 30;
    if (diYu >= 10) diYu = diYu % 10;
  } else {
    diYu = diShuSum % 10;
  }
  if (diYu === 0) diYu = 10;
  return diYu;
}
```

**洛书九宫配卦：**
| 数 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 |
|----|---|---|---|---|---|---|---|---|---|---|
| 卦 | 坎 | 坤 | 震 | 巽 | 寄坤 | 乾 | 兑 | 艮 | 离 | 寄坤 |

**上下卦位置口诀：** "阳男阴女顺，阴男阳女逆"
- 顺：天卦上、地卦下
- 逆：地卦上、天卦下

### 5.4 成卦法B（年干起卦 + 动爻）

```typescript
// 年干起卦口诀
const NIANGAN_GUA_MAP = {
  '甲': '乾', '乙': '坤', '丙': '艮', '丁': '兑', '戊': '坎',
  '己': '离', '庚': '震', '辛': '巽', '壬': '乾', '癸': '坤'
};

// 动爻计算（依据《京房易》《火珠林》）
function calculateDongYao(totalSum: number): number {
  const remainder = totalSum % 6;
  // 关键！余0 = 上爻动，非"无动爻"或"初爻"
  return remainder === 0 ? 6 : remainder;
}

// 动爻对应
// 余1 → 初爻动  
// 余2 → 二爻动  
// 余3 → 三爻动  
// 余4 → 四爻动  
// 余5 → 五爻动  
// 余0 → 上爻动（关键！）
```

### 5.5 体用综合分析

```typescript
// 体用合参规则
function analyzeTiYong(tiLuck: string, yongLuck: string): string {
  if (tiLuck === '吉' && yongLuck === '吉') return '大吉';   // 体用皆吉
  if (tiLuck === '吉' && yongLuck === '凶') return '中平';   // 怀才不遇
  if (tiLuck === '凶' && yongLuck === '吉') return '中平';   // 有才无运
  if (tiLuck === '凶' && yongLuck === '凶') return '大凶';   // 多灾多难
  return '平';
}
```

**体用关系：**
- **体卦**管“能不能成”——先天格局高低、根基深浅
- **用卦**管“怎么成、何时成”——实现路径、应期时机

### 5.6 八卦相荡法

```typescript
// 本命卦×流年卦 → 荡出流年运势卦
function calculateXiangDang(
  benMingGua: ChongGuaInfo,
  liuNianGan: string,
  gender: string,
  yearGan: string
): XiangDangResult {
  // 1. 流年起卦（用B法：年干→卦）
  const liuNianGua = getNianGanGua(liuNianGan);
  
  // 2. 本命卦×流年卦 → 荡出卦
  const dangGua = xiangDang(benMingGua, liuNianGua);
  
  // 3. 判断体用关系 → 吉凶
  const tiYong = analyzeTiYong(dangGua, gender, yearGan);
  
  return { dangGua, tiYong, luck, desc };
}
```

### 5.7 定元堂式

```typescript
// 在卦中找到命主的位置
function defineYuanTang(
  chongGua: ChongGuaInfo,
  shichenIndex: number,
  gender: string,
  yearGan: string
): YuanTangInfo {
  // 1. 判断时辰阴阳：阳时报阳爻，阴时报阴爻
  const isYangShi = shichenIndex % 2 === 0;
  
  // 2. 判断卦类型：纯卦/杂卦
  const isPure = (chongGua.upperGua.name === chongGua.lowerGua.name);
  
  if (isPure) {
    // 乾坤纯卦：需考虑节气和阴阳顺逆
    return handlePureGua(chongGua, gender, yearGan);
  } else {
    // 杂卦：循环分配六爻
    return handleMixedGua(chongGua, isYangShi);
  }
}
```

### 5.8 起月卦

```typescript
// 推算流月运势
function calculateLiuYueGua(
  yuanTangYao: number,
  dayGan: string,
  month: number
): LiuYueGuaInfo {
  // 1. 月支→月卦
  const monthZhi = MONTH_ZHI_MAP[month];
  const monthGua = getGuaByZhi(monthZhi);
  
  // 2. 主爻位 = (元堂爻位 + 月数) mod 6
  const zhuYao = ((yuanTangYao + month - 1) % 6) + 1;
  
  // 3. 五行生克判吉凶
  const relation = wuxingRelation(dayGan, monthGua.wuxing);
  
  return { month, monthGua, zhuYao, relation, luck };
}
```

### 5.9 起日卦

```typescript
// 推算流日运势
function calculateLiuRiGua(
  dayZhi: string,
  dayGan: string
): LiuRiGuaInfo {
  // 1. 日支→日卦
  const dayGua = getGuaByZhi(dayZhi);
  
  // 2. 动爻位 = 日支序数 mod 6
  const dongYao = (DI_ZHI.indexOf(dayZhi) % 6) + 1;
  
  // 3. 五行关系判断
  const relation = wuxingRelation(dayGan, dayGua.wuxing);
  
  return { dayZhi, dayGua, dongYao, relation, luck };
}
```

### 5.10 小象行年卦气

```typescript
// 推算流年卦气爻位
function calculateXiaoXiang(
  yuanTangYao: number,
  age: number,
  gender: string,
  yearGan: string
): XiaoXiangResult {
  // 1. 判断顺逆：阳男阴女顺行，阴男阳女逆行
  const isShun = isYangMingNan(gender, yearGan) || isYinMingNv(gender, yearGan);
  
  // 2. 计算当前爻位（一爻一年，循环）
  let currentYao: number;
  if (isShun) {
    currentYao = ((yuanTangYao + age - 1) % 6) + 1;
  } else {
    currentYao = ((yuanTangYao - age + 1 + 6000) % 6) + 1;
  }
  
  // 3. 获取爻辞和小象辞
  const xiaoXiangData = getXiaoXiangByYao(currentYao);
  
  return { age, currentYao, ...xiaoXiangData };
}
```

---

## 六、UI组件

### 6.1 组件列表

| 组件 | 文件 | 功能 |
|------|------|------|
| BaguaChart | BaguaChart.ets | 八卦图（元气图、化工图） |
| YouNianChart | YouNianChart.ets | 游年图（八方九宫布局） |
| QiuShuChart | QiuShuChart.ets | 求数法（阴阳分布、四柱明细） |
| ZhengTongGuaChart | ZhengTongGuaChart.ets | A法成卦（天地余数、命卦显示） |
| NianGanGuaChart | NianGanGuaChart.ets | B法成卦（本卦、动爻、变卦） |
| TiYongAnalysis | TiYongAnalysis.ets | 体用综合（对照表、建议） |
| XiangDangChart | Index.ets (内嵌) | 八卦相荡（10年流年运势） |
| YuanTangInfo | Index.ets (内嵌) | 定元堂式（命主定位） |
| LiuYueDisplay | Index.ets (内嵌) | 起月卦（12月宫格） |
| LiuRiDisplay | Index.ets (内嵌) | 起日卦（今日运势） |
| XiaoXiangDisplay | Index.ets (内嵌) | 小象行年（爻辞、小象辞） |

### 6.2 UI布局结构

应用采用**三Tab分页**布局：

```
[定性] [定量] [流年]
  ↓       ↓       ↓
定性分析 定量分析 流年分析
```

**Tab1 定性**：
- 四柱基本信息
- 元气图（生年本命卦）
- 化工之图（生月得令）
- 游年图（八方吉凶）

**Tab2 定量**：
- 求数法（四柱数理）
- A法成卦（先天命卦）
- B法成卦（后天命盘）
- 体用综合分析

**Tab3 流年**：
- 八卦相荡法（10年运势）
- 定元堂式（命主定位）
- 起月卦（12月运势）
- 起日卦（今日运势）
- 小象行年（当前虚岁）

### 6.3 设计风格
- **主色调**：古典红棕色 (#8B0000, #8B4513)
- **辅助色**：金色 (#D4AF37)、青铜色
- **背景色**：米黄/象牙白 (#FFFEF9, #FDF8F0)
- **字体**：宋体风格，层次分明

---

## 七、核心算法详解

### 7.1 时柱计算（五鼠遁时法）

```typescript
// 根据日干和时辰计算时干
function calculateHourGan(dayGan: string, shichenIndex: number): string {
  // 五鼠遁时口诀：
  // 甲己之日：甲子起时（时干从0开始）
  // 乙庚之日：丙子起时（时干从2开始）
  // 丙辛之日：戊子起时（时干从4开始）
  // 丁壬之日：庚子起时（时干从6开始）
  // 戊癸之日：壬子起时（时干从8开始）
  
  const startGanMap = {
    '甲': 0, '己': 0,
    '乙': 2, '庚': 2,
    '丙': 4, '辛': 4,
    '丁': 6, '壬': 6,
    '戊': 8, '癸': 8
  };
  const hourGanIndex = (startGanMap[dayGan] + shichenIndex) % 10;
  return TIAN_GAN[hourGanIndex];
}
```

---

## 八、关键修正记录

### 8.1 A法成卦规则修正

**问题**：原代码对所有情况统一使用 `(和 - 25/30) mod 10`

**修正**：按《皇极经世》古法分情况处理

| 情况 | 天数处理 | 地数处理 |
|------|---------|------|
| 和 ≥ 25/30 | 和 − 25，若≥10取个位 | 和 − 30，若≥10取个位 |
| 和 < 25/30 | 直接取和的个位数 | 直接取和的个位数 |

### 8.2 B法动爻规则修正

**问题**：`余0`的处理不明确

**修正**：明确 `余0 = 上爻动`（非"无动爻"或"初爻"）

```
余1→初爻, 余2→二爻, 余3→三爻, 余4→四爻, 余5→五爻, 余0→上爻
```

### 8.3 代码规范修正

**问题1：错别字**
- "动爻"误写为"动爵"
- "上爻"误写为"上爸"

**修正**：全局替换，统一使用"爻"(yáo)

**问题2：ArkTS类型规范**
- 不能使用对象字面量作为类型声明

**修正**：创建正式class替代`{ yaoCi: string, ... }`形式

---

## 九、编译与运行

### 9.1 环境要求
- DevEco Studio 5.0+
- HarmonyOS SDK API 12+
- Node.js 18+

### 9.2 编译命令
```powershell
cd d:\DevEcoStudioProjects\LuoShuCodeII
hvigorw assembleHap --no-daemon
```

### 9.3 输出文件
```
entry/build/default/outputs/default/entry-default-signed.hap
```

---

## 十、项目状态

### 10.1 已完成功能

✅ **定性分析（完整）**：
- 四柱生成
- 元气图
- 化工之图
- 化工相反之图
- 游年图

✅ **定量分析（完整）**：
- 求数法
- 成卦法A（正统法）
- 成卦法B（年干起卦+动爻法）
- 体用综合分析

✅ **流年分析（完整）**：
- 八卦相荡法（10年运势）
- 定元堂式（命主定位）
- 起月卦（12月运势）
- 起日卦（今日运势）
- 小象行年卦气（虚岁运势）

### 10.2 技术特点

- **纯前端计算**：无需网络，数据安全
- **规则驱动**：算法规则JSON化，易维护
- **分层架构**：Model-Service-View分离
- **Tab分页**：清晰的信息层级
- **古法严格遵循**：基于《皇极经世》《河洛真数》古籍

### 10.3 当前版本

- **版本号**：v2.0
- **更新时间**：2026年1月11日
- **编译状态**：✅ BUILD SUCCESSFUL
- **代码质量**：已修复所有已知错误

---

## 十一、未来扩展方向

根据河洛数卦体系，可考虑扩展：

1. **六亲纳甲系统** - 装六亲、定世应、查旺衰
2. **应期推算** - 结合化工图精确推算应期时间
3. **数据统计** - 命卦分布统计、吉凶概率分析
4. **云端备份** - 用户数据云端同步（可选）
5. **AI辅助解读** - 结合大模型提供详细解释

---

## 十二、参考文献

1. 《皇极经世》- 北宋·邵雍
2. 《河洛真数》- 古法命理经典
3. 《京房易》- 六爻纳甲体系
4. 《火珠林》- 动爻变卦规则

---

*文档版本：v2.0*  
*更新日期：2026年1月11日*  
*最后编译：BUILD SUCCESSFUL in 5s*
